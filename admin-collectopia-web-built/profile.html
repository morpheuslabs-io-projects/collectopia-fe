
        <!doctype html>
        <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta name="icon" content="https://ml-webstudio-dev.s3.ap-southeast-1.amazonaws.com/morpheuslabs/favicon.png"></meta><meta name="title" content="admin-collectopia"></meta><meta name="description" content="admin-collectopia"></meta><meta name="author" content="https://admin-collectopia.dev.morpheuslabs.io"></meta><meta name="article:publisher" content="https://admin-collectopia.dev.morpheuslabs.io"></meta><meta property="og:locale" content="en_US"></meta><meta property="og:type" content="website"></meta><meta property="og:url" content="https://admin-collectopia.dev.morpheuslabs.io"></meta><meta property="og:site_name" content="admin-collectopia"></meta><meta property="og:title" content="admin-collectopia"></meta><meta property="og:description" content="admin-collectopia"></meta><meta property="og:image" content="https://ml-webstudio-dev.s3.ap-southeast-1.amazonaws.com/morpheuslabs/ml-banner.png"></meta><meta property="twitter:card" content="summary_large_image"></meta><meta property="twitter:title" content="admin-collectopia"></meta><meta property="twitter:url" content="https://admin-collectopia.dev.morpheuslabs.io"></meta><meta property="twitter:description" content="admin-collectopia"></meta><meta property="twitter:image" content="https://ml-webstudio-dev.s3.ap-southeast-1.amazonaws.com/morpheuslabs/ml-banner.png"></meta><meta property="twitter:creator" content="https://admin-collectopia.dev.morpheuslabs.io"></meta>
        <title>admin-collectopia</title>
        <link rel="icon" sizes="192x192" href="">
        <link rel="shortcut icon" href="https://ml-webstudio-dev.s3.ap-southeast-1.amazonaws.com/morpheuslabs/favicon.png" type="image/png">
        <link rel="apple-touch-icon" href="https://ml-webstudio-dev.s3.ap-southeast-1.amazonaws.com/morpheuslabs/favicon.png" type="image/png">
    
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
			      <link rel="stylesheet" href="https://webstudio.morpheuslabs.io/sdk/qrscanner.css?v=1">
			      <link rel="stylesheet" href="https://webstudio.morpheuslabs.io/fonts/font.css?v=1">
            <link rel="stylesheet" href="https://fonts.cdnfonts.com/css/strasua" /><link rel="stylesheet" href="https://fonts.cdnfonts.com/css/good-times-2" /><link rel="stylesheet" href="https://fonts.cdnfonts.com/css/pirulen" /><link rel="stylesheet" href="https://fonts.cdnfonts.com/css/open-sans" /><link rel="stylesheet" href="https://fonts.cdnfonts.com/css/montserrat" /><link rel="stylesheet" href="https://fonts.cdnfonts.com/css/abril-fatface" />
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/web3@4.8.0/dist/web3.min.js"></script>
            <script src="https://unpkg.com/web3modal@1.9.3/dist/index.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
            <script src="https://unpkg.com/@walletconnect/web3-provider@1.6.6/dist/umd/index.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/bignumber.js/9.1.2/bignumber.min.js" integrity="sha512-9JMv6qShmz4L6iAvMaEoIaFtS4XGSk/jeTSR2vzieg0XS5njYvBvYk0YcvI59dLN/0B+QnG5HfGR+Mqubl78SA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
            <script src="https://cdn.jsdelivr.net/npm/webstudio-sdk@1.0.14/dist/main.min.js"></script>
            <script>
              
class AppContract {
  web3 = null;

  constructor(props) {
    this.contract = props.contract;
    this.metadata = props.metadata;
    this.account = localStorage.getItem('walletAddress');

    if (window.ethereum) {
      this.web3 = new Web3(window.ethereum);
    };
  }

  getContract() {
    return this.contractInstance();
  }

  getMetadata() {
    return this.metadata;
  }

  setAccount(address) {
    this.account = address;
  }

  getAccount() {
    return localStorage.getItem('walletAddress');
  }

  contractInstance() {
    let contractABI = JSON.parse(this.contract.abi);
    if (!contractABI || !this.contract.address) return;

    return new this.web3.eth.Contract(contractABI, this.contract.address);
  }

  convertBigNumber(bigNumber, decimal = 18) {
    if (!bigNumber) return 0;

    if (bigNumber._isBigNumber) {
      return bigNumber.div(new window.BigNumber(10).pow(decimal).toString()).toNumber();
    }

    let number = new window.BigNumber(bigNumber);

    return number.div(new window.BigNumber(10).pow(decimal).toString()).toNumber();
  }

  getExplorerLink(txHash = '') {
    let networkScans = {
      '1': 'https://etherscan.io',
      '56': 'https://bscscan.com',
      '137': 'https://polygonscan.com',
      '11155111': 'https://sepolia.etherscan.io',
      '97': 'https://testnet.bscscan.com',
      '80002': 'https://amoy.polygonscan.com',
    }

    return networkScans[this.contract.network] + '/tx/' + txHash;
  }
}

window.AppContract = AppContract;
;
              
class AppAPIModule {
  constructor(props) {
    this.api = JSON.parse(props.api || '""');
  }

  getAPI() {
    return this.api;
  }
}

window.AppAPIModule = AppAPIModule;
;
              
              
            </script>
            <style>
                html {
                    scroll-behavior: smooth;
                }
                * { box-sizing: border-box; } body {margin: 0;}html{scroll-behavior:smooth;}*{box-sizing:border-box;}body{margin-top:0px;margin-right:0px;margin-bottom:0px;margin-left:0px;overflow-x:auto !important;overflow-y:auto !important;}html, body{font-family:Poppins, sans-serif;font-weight:400;}span + span{padding-left:0.23em;}.rounded-14{border-top-left-radius:14px;border-top-right-radius:14px;border-bottom-right-radius:14px;border-bottom-left-radius:14px;}
            </style>
            
          </head>
          <body id="im7ivn"><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""/><link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet"/><link rel="stylesheet" href="index.css"/><title id="ilb6yh">Collectopia Admin Portal - Profile</title><div id="ix36xi"><script>
    window.onload = () => {
      const X_API_KEY = "ToVi388ImKgaGtK00srdyndmAQaKQZbzZKeoHk+JX+Y=";
      const REFERRER = "morpheuslabs.io";
      const BASE_URL =
        "https://wfstudiobe.morpheuslabs.io/api/v1/webhooks/cardtopia";

      /**
       * @template T
       * @param {T} initialValue
       * @param {string} name: If name different undefined will auto save to localStorage
       * @returns {{value: T, setValue: (value:T)=> void, callbacks:((value:T,oldValue:T)=> void)[]}}
       */
      const useState = (initialValue, name) => {
        const state = {
          value: initialValue,
          setValue: (value) => {
            const oldValue = state.value;
            state.value = value;
            if (name) {
              if (typeof value === "string") {
                if (value) localStorage.setItem(name, value);
                else localStorage.removeItem(name);
              } else
                console.error(
                  "Auto save localstorage only supported string value"
                );
            }
            if (value !== oldValue)
              state.callbacks.map((cb) => cb(value, oldValue));
          },
          callbacks: [],
        };
        return state;
      };
      const token = localStorage.getItem("token");

      if (!token) {
        window.location.href = "/index.html";
      }

      const profileList = useState([], "profile-list");

      const profileTabChangePassword = $("#profile-tab-change-password");
      const profileTabTransactions = $("#profile-tab-transactions");
      const profileTabLogout = $("#profiletab-logout");

      profileTabChangePassword.on("click", () => {
        window.location.href = "/change-password.html";
      });

      profileTabLogout.on("click", () => {
        localStorage.removeItem("token");
        window.location.href = "/index.html";
      });

      profileTabTransactions.on("click", () => {
        window.location.href = "/transaction.html";
      });

      const loadingProfile = useState(true, "loading-profile");
      const getProfile = async () => {
        loadingProfile.setValue(true);
        const response = await fetch(`${BASE_URL}/admin/user-profile`, {
          headers: {
            "X-API-KEY": X_API_KEY,
            Authorization: `Bearer ${token}`,
            Referer: REFERRER,
            "Content-Type": "application/json",
          },
        });

        const data = await response
          .json()
          .then((res) => {
            profileList.setValue(
              JSON.stringify(Object.values(res[0].data.users))
            );
          })
          .finally(() => {
            loadingProfile.setValue(false);
          });
      };

      loadingProfile.callbacks.push((value, oldValue) => {
        if (value) {
          $("#loading-profile").removeClass("hidden");
        } else {
          $("#loading-profile").addClass("hidden");
          $("#profile-table-table").removeClass("hidden");
        }
      });

      profileList.callbacks.push((value, oldValue) => {
        const profileTemplate = $("#profile-table-table-row");

        // Remove old NFT item
        if (oldValue.length > 0 ? JSON.parse(oldValue) : [])
          $("#profile-table-table-body").empty();

        // Render NFT item
        (JSON.parse(value) || []).forEach((item, index) => {
          console.log("🚀 ~ item:", item);
          const profileRow = profileTemplate.clone();
          // Show all columns by removing hidden class
          profileRow.find("td").removeClass("hidden");

          // Set data for each column
          profileRow
            .find(".profile-table-table-col-name")
            .text(item.fullname || "-");
          profileRow
            .find(".profile-table-table-col-username")
            .text(item.username || "-");
          profileRow
            .find(".profile-table-table-col-walletaress")
            .text(item.wallet_address || "-");
          profileRow
            .find(".profile-table-table-col-email")
            .text(item.email || "-");
          profileRow
            .find(".profile-table-table-col-phone")
            .text(item.phone_number || "-");
          profileRow
            .find(".profile-table-table-col-joined_date")
            .text(
              item.created_at
                ? new Date(item.created_at).toLocaleDateString()
                : "-"
            );

          // Add row to table body
          $("#profile-table-table-body").append(profileRow);
        });
      });

      getProfile();
    };
  </script></div><div class="min-h-screen bg-[#F4F7F8]"><div class="flex justify-between items-center px-10 bg-white"><div id="ib273y"></div><div class="flex justify-center items-center w-screen bg-white gap-x-10"><div id="ixkraz" class="text-[14px] text-[#252525] py-5 cursor-pointer">
            Summary
          </div><div id="ih69jf" class="text-[14px] text-[#252525] font-bold py-5 border-b border-[#E8D65F]">
            Profile
          </div><div id="profile-tab-transactions" class="text-[14px] text-[#252525] py-5 cursor-pointer">
            Transactions
          </div></div><div class="flex gap-x-10"><div id="profile-tab-change-password" class="cursor-pointer w-max">
            Change password
          </div><div id="profiletab-logout" class="cursor-pointer">
            Logout
          </div></div></div><div class="mt-4"><div class="flex gap-x-10 items-center px-10 mt-4"><div id="iyscgy" class="text-[24px] text-[#252525] font-bold">
            Profile Management
          </div><input type="text" placeholder="Search" class="w-[300px] h-[40px] border border-[#D9D9D9] text-[#252525] p-4 rounded-14"/></div><div id="loading-profile" class="flex justify-center items-center px-10 mt-10"><div class="text-[14px] text-[#252525] font-bold"><div class="text-[14px] text-[#252525] font-bold"><div class="flex space-x-2"><div class="w-4 h-4 bg-blue-500 rounded-full animate-bounce -animation-delay:-0-3s-"></div><div class="w-4 h-4 bg-blue-500 rounded-full animate-bounce -animation-delay:-0-15s-"></div><div class="w-4 h-4 bg-blue-500 rounded-full animate-bounce"></div></div></div></div></div><div id="profile-table-table" class="px-10 mt-10 hidden"><div><table class="w-full border-separate border-spacing-y-2"><thead><tr><th class="text-[14px] text-[#252525] font-light text-left px-2 py-2">
                    Name
                  </th><th class="text-[14px] text-[#252525] font-light text-left px-2">
                    @username
                  </th><th class="text-[14px] text-[#252525] font-light text-left px-2">
                    Wallet Address
                  </th><th class="text-[14px] text-[#252525] font-light text-left px-2">
                    email
                  </th><th class="text-[14px] text-[#252525] font-light text-left px-2">
                    phone
                  </th><th class="text-[14px] text-[#252525] font-light text-left px-2">
                    joined date
                  </th></tr></thead><tbody id="profile-table-table-body" class="mt-4"><tr id="profile-table-table-row" class="bg-white"><td class="hidden px-2 py-5 text-[14px] font-medium text-left profile-table-table-col-name"></td><td class="hidden px-2 py-5 text-[14px] font-medium text-left profile-table-table-col-username"></td><td class="hidden px-2 py-5 text-[14px] font-medium text-left profile-table-table-col-walletaress"></td><td class="hidden px-2 py-5 text-[14px] font-medium text-left profile-table-table-col-email"></td><td class="hidden px-2 py-5 text-[14px] font-medium text-left profile-table-table-col-phone"></td><td class="hidden px-2 py-5 text-[14px] font-medium text-left profile-table-table-col-joined_date"></td></tr></tbody></table></div><div class="flex gap-x-10 items-center"><div id="irgjbt" class="text-[16px] font-bold mt-4 bg-[#252525] text-white text-center w-[24px] h-[24px]">
              1
            </div></div></div></div></div><!-- QR SCAN LIB --><!--<script src="https://cdn.jsdelivr.net/npm/web3@4.8.0/dist/web3.min.js"></script> --></body><script>var props = {"im7ivn":{"contract":"---","metadata":"","api":"---"}};
          var ids = Object.keys(props).map(function(id) { return '#'+id }).join(',');
          var els = document.querySelectorAll(ids);
          for (var i = 0, len = els.length; i < len; i++) {
            var el = els[i];
            (function(e){const{contract:t,metadata:n,api:a}=e;if(t){const e=JSON.parse(atob(t||"")||'""');if(!e)return;localStorage.setItem("AppContract",JSON.stringify(e)),window.AppContract&&(window.$appContract=new window.AppContract({contract:e,api:a,metadata:n}),console.log("$appContract ==>>",window.$appContract))}a&&(localStorage.setItem("AppAPI",a),window.AppAPIModule&&(window.$appAPI=new window.AppAPIModule({api:a}),console.log("$appAPI ==>>",window.$appAPI))),localStorage.setItem("AppMetadata",n||"")}.bind(el))(props[el.id]);
          }
          var props = {"ilb6yh":{},"ixkraz":{},"ih69jf":{},"profile-tab-transactions":{},"profile-tab-change-password":{},"profiletab-logout":{},"iyscgy":{},"irgjbt":{}};
          var ids = Object.keys(props).map(function(id) { return '#'+id }).join(',');
          var els = document.querySelectorAll(ids);
          for (var i = 0, len = els.length; i < len; i++) {
            var el = els[i];
            (async function(e){let t=this.getAttribute("datasource");if("api"===t){const e=this.getAttribute("apiUse");e&&window.addEventListener(e,(async e=>{const t=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;const a=n=>String.prototype.split.call(t,n).filter(Boolean).reduce(((e,t)=>null!==e&&void 0!==e?e[t]:e),e),o=a(/[,[\]]+?/)||a(/[,[\].]+?/);return void 0===o||o===e?n:o}(e.detail,this.getAttribute("mappingresponse"),0);var n;this.innerHTML=(n=t,isNaN(n)||null===n||""===n?n:parseFloat(n).toFixed(2))}))}else if("smart_contract"===t){const t=e;let a=t.contract||this.getAttribute("contract"),o=t.method||this.getAttribute("method"),s=t.params||"",i=t.isBignumber||!1,r=t.decimal||0,l=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:18;return e?e._isBigNumber?e.div(new window.BigNumber(10).pow(t).toString()).toNumber():new window.BigNumber(e).div(new window.BigNumber(10).pow(t).toString()).toNumber():0},d=JSON.parse(atob(a||"")||'""');if(!d||!d.abi)return;let c=JSON.parse(atob(o||"")||'""');if(!c)return;s=s.split(",").map((e=>e.trim()));const p=new(new window.Web3(d.rpcURL||window.ethereum).eth.Contract)(JSON.parse(d.abi),d.address);let u="";try{u=await p.methods[c.name](...s).call()}catch(n){console.error("Error calling contract method:",n)}i&&r?(u=l(u,parseInt(r||0)),this.innerText=isNaN(u)?0:u):this.innerText=u}}.bind(el))(props[el.id]);
          }</script>
          <!-- EXTRA & MORPHEUS SDK LIB -->
          <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
          <script src="https://webstudio.morpheuslabs.io/sdk/keyboard.js?v=0.0.2"></script>
          <script src="https://webstudio.morpheuslabs.io/sdk/callApi.js?v=0.0.1"></script>
          <!-- QR SCAN LIB -->
          <script src="https://unpkg.com/html5-qrcode"></script>
          <script src="https://webstudio.morpheuslabs.io/sdk/qrscanner.js?v=1"></script>
          <!--<script src="https://cdn.jsdelivr.net/npm/web3@4.8.0/dist/web3.min.js"></script> -->
          <script src="https://webstudio.morpheuslabs.io/sdk/modal.js?v=0.0.1"></script>

          <script>
            
      function getDataByPath(obj, path, defaultValue = undefined) {
        const travel = (regexp) =>
          String.prototype.split
            .call(path, regexp)
            .filter(Boolean)
            .reduce(
              (res, key) =>
                res !== null && res !== undefined ? res[key] : res,
              obj
            );
        const result = travel(/[,\[\]]+?/) || travel(/[,\[\].]+?/);
        return result === undefined || result === obj ? defaultValue : result;
      }
      function formatString(input) {
        // Check if the input is a number or a string that can be converted to a number
        if (!isNaN(input) && input !== null && input !== "") {
          // Convert to number and format with 2 decimal places
          return parseFloat(input).toFixed(2);
        } else {
          // Return the input as is if it's not a number
          return input;
        }
      }
    
            
const SWAP_MODULE = {
  swapInValue: 0,
  swapOutValue: 0,
  userAllowance: 0,
  isApprovedUSDT: false,
  isApprovedQMGT: false,
  contractABI: null,
  contractAddress: null,
  tokenAddress: null,
  contract: null,
  web3: null,
  isBuyPage: window.location.pathname === '/buy-token.html', // Fixme: remove hardcode page
  account: localStorage.getItem('walletAddress'),
  swapContract: JSON.parse(localStorage.getItem('SwapContract') || '""'),
  buyTokenPage: localStorage.getItem('SwapPageURL'),
  swapSuccessPage: localStorage.getItem('SwapSuccessPageURL'),
  tokenSwapABI: [{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}],
  selectorSwapConnectMetamask: '.swap-connect-metamask',
  selectorSwapConnectMetamaskID: 'swap-connect-metamask',
  selectorSwapConnectCoinbase: '.swap-connect-coinbase',
  selectorSwapConnectCoinbaseID: 'swap-connect-coinbase',
  selectorSwapConnectWeb3modal: '.swap-connect-web3modal',
  selectorSwapConnectWeb3modalID: 'swap-connect-web3modal',
  selectorSwapSubmitID: 'swap-submit',
  selectorSwapSubmitID1: 'swap-submit1',
  selectorSwapTxSuccessLinkID: 'swap-tx-success-link',
  selectorSwapInputIn: '#swap-input-in input',
  selectorSwapInputOutID: 'swap-input-out',
  selectorSwapTokenBalance: '.swap-balance-token',
  selectorSwapQMGTBalance: '.swap-balance-qmgt',
  selectorSwapBalanceInID: 'swap-balance-in',
  selectorSwapBalanceOutID: 'swap-balance-out',
  selectorSwapBalanceInID1: 'swap-balance-in1',
  selectorSwapBalanceOutID1: 'swap-balance-out1',
  selectorConnectedAddress: '.swap-connected-address',
  selectorSwapSuccessDescriptionID: 'swap-success-description',

  init: async function() {
    if (!window.ethereum) return;
    this.web3 = new Web3(window.ethereum);

    this.getSwapContract();
    this.getSwapContractABI();
    this.getSwapContractAddress();
    this.getTokenSwapAddress();
    this.getSwapPage();
    this.getSwapSuccessPage();

    // Verify approved
    this.verifyUserApproved();

    this.displayConnectedAccount(this);

    await this.displayBalances();

    this.listenConnectWallet(this);
    this.listenSwapAction(this);
    this.listenChangeSwapInput(this);

    this.renderTxLink();

    let that = this;
    try {
      let sellInput = document.querySelector('#swap-input-in1 input');
      if (sellInput) {
        sellInput.addEventListener('input', async function(event) {
          let value = event.target.value;

          that.swapInValue = value;
          
          const contract = that.swapContractInstance();
          try {
            let result = await contract.methods.calculateUSDT(that.web3.utils.toWei(value, 'ether')).call();
            result = that.convertBigNumber(result, 6);
            result = result ? Math.floor(result * 10000) / 10000 : result;

            let sellOutput = document.querySelector('#swap-input-out1 input');
            if (sellOutput) {
              sellOutput.value = result;
            }
          } catch (error) {
           console.log('Error ==>>', error); 
          }
        })
      }
    } catch (error) {
      
    }
  },

  verifyUserApproved: async function() {
    try {
      const tokenContract = this.tokenContractInstance();
      if (!tokenContract) return;

      let allowanceUSDT = await tokenContract.methods.allowance(this.account, this.contractAddress).call();
      // let allowanceUSDT = await tokenContract.methods.allowance('0xaB39e895C7Ae813b2AeE51b883203e76c6cDb05f', this.contractAddress).call();
      allowanceUSDT = this.convertBigNumber(allowanceUSDT);
      this.isApprovedUSDT = allowanceUSDT > 0;

      const swapContract = this.swapContractInstance();
      let allowanceQMGT = await swapContract.methods.allowance(this.account, this.contractAddress).call();
      // let allowanceQMGT = await swapContract.methods.allowance('0xaB39e895C7Ae813b2AeE51b883203e76c6cDb05f', this.contractAddress).call();
      allowanceQMGT = this.convertBigNumber(allowanceQMGT);
      this.isApprovedQMGT= allowanceQMGT > 0;

      return {
        isApprovedUSDT: this.isApprovedUSDT,
        isApprovedQMGT: this.isApprovedQMGT,
      }
    } catch (error) {
      console.log('error ==>>', error);
    }
  },

  displayConnectedAccount: function(context) {
    let that = this;
    let addrElements = this.getConnectedAddressElement();
    if (!addrElements || !addrElements.length || !this.account) return;

    addrElements.forEach(element => {
      element.innerText = context.shortenAddress(this.account, 4, 6);

      element.addEventListener('click', function(event) {
        that.handleDisconnect();
      })
    })
  },

  handleDisconnect: function() {
    let confirmDisconnect;
    confirmDisconnect = confirm('Do you want to disconnect?');
    if (confirmDisconnect) {
      localStorage.removeItem('walletAddress');
      this.account = null;

      window.location.href = window.location.origin
    }
  },

  listenConnectWallet: function(context) {
    let btnConnectWithID = document.getElementById(this.selectorSwapConnectMetamaskID);
    if (btnConnectWithID) {
      btnConnectWithID.addEventListener('click', function(event) {
        context.connectMetamask();
      });
    }

    let btnCoinbaseID = document.getElementById(this.selectorSwapConnectCoinbaseID);
    if (btnCoinbaseID) {
      btnCoinbaseID.addEventListener('click', function(event) {
        context.connectCoinbase();
      });
    }

    let btnWeb3modalID = document.getElementById(this.selectorSwapConnectWeb3modalID);
    if (btnWeb3modalID) {
      btnWeb3modalID.addEventListener('click', function(event) {
        context.connectWeb3modal();
      });
    }

    let btnsConnect = document.querySelectorAll(this.selectorSwapConnectMetamask);
    if (btnsConnect && btnsConnect.length) {
      for (let index = 0; index < btnsConnect.length; index++) {
        btnsConnect[index].addEventListener('click', function(event) {
          context.connectMetamask();
        });
      }
    }

    let btnsConnectCoinbase = document.querySelectorAll(this.selectorSwapConnectCoinbase);
    if (btnsConnectCoinbase && btnsConnectCoinbase.length) {
      for (let index = 0; index < btnsConnectCoinbase.length; index++) {
        btnsConnectCoinbase[index].addEventListener('click', function(event) {
          context.connectCoinbase();
        });
      }
    }

    let btnsConnectWeb3modal = document.querySelectorAll(this.selectorSwapConnectWeb3modal);
    if (btnsConnectWeb3modal && btnsConnectWeb3modal.length) {
      for (let index = 0; index < btnsConnectWeb3modal.length; index++) {
        btnsConnectWeb3modal[index].addEventListener('click', function(event) {
          context.connectWeb3modal();
        });
      }
    }
  },

  listenSwapAction: function(context) {
    let swapSubmitBtn = document.getElementById(this.selectorSwapSubmitID);
    if (swapSubmitBtn) {
      swapSubmitBtn.addEventListener('click', function(event) {
        context.swapTokens();
      });
    }

    let swapSubmitBtn1 = document.getElementById(this.selectorSwapSubmitID1);
    if (swapSubmitBtn1) {
      swapSubmitBtn1.addEventListener('click', function(event) {
        context.swapTokens();
      });
    }
  },

  listenChangeSwapInput: function(context) {
    let swapInElement = this.getSwapInElement();
    if (!swapInElement) return;

    swapInElement.addEventListener('input', function(event) {
      let amount = parseFloat(event.target.value);
      context.swapInValue = isNaN(amount) ? 0 : amount;

      // Display the output of swap
      context.calculateOutputBuy();
    });
  },

  getSwapContract: function() {
    let localSwapContract = localStorage.getItem('SwapContract');
    if (localSwapContract && !this.swapContract) {
      this.swapContract = JSON.parse(localSwapContract);
    }
  },

  getSwapContractABI: function() {
    let localSwapContractABI = localStorage.getItem('SwapContractABI');
    if (localSwapContractABI) {
      this.contractABI = JSON.parse(localSwapContractABI);
    }
  },

  getSwapContractAddress: function() {
    let localSwapContractAddress = localStorage.getItem('SwapContractAddress');
    if (localSwapContractAddress) {
      this.contractAddress = localSwapContractAddress;
    }
  },

  getTokenSwapAddress: function() {
    let localTokenSwapAddress = localStorage.getItem('TokenSwapAddress');
    if (localTokenSwapAddress) {
      this.tokenAddress = localTokenSwapAddress;
    }
  },

  getSwapPage: function() {
    let localSwapPageURL = localStorage.getItem('SwapPageURL');
    if (localSwapPageURL) {
      this.buyTokenPage = localSwapPageURL;
    }
  },

  getSwapSuccessPage: function() {
    let localSwapSuccessPageURL = localStorage.getItem('SwapSuccessPageURL');
    if (localSwapSuccessPageURL) {
      this.swapSuccessPage = localSwapSuccessPageURL;
    }
  },

  swapTokens: async function() {
    if (!this.swapInValue) {
      alert('Please enter an amount to swap!');

      return;
    }
  
    if (!this.account) {
      alert('Please connect to your wallet!');
      this.connectMetamask();
      return;
    }

    if ((this.isBuyPage && !this.isApprovedUSDT) || (!this.isBuyPage && !this.isApprovedQMGT)) {
      alert('You need to approve before Swap!');
      this.approveToken();
      return;
    }

    if (!this.isBuyPage) {
      if (parseFloat(this.swapInValue) < 0.1) {
        alert('Minimum amount must be 0.1!')

        return;
      }

      if (parseFloat(this.swapInValue) > 100) {
        alert("Maximum amount can't exceed 100!")

        return;
      }
    }

    const contract = this.swapContractInstance();

    try {
      let method = this.isBuyPage ? 'buyTokens' : 'sellTokens'

      const result = await contract.methods[method](this.web3.utils.toWei(this.swapInValue, this.isBuyPage ? 'Mwei': 'ether')).send({ from: this.account });

      // Update balance after success
      this.displayBalances();

      alert('Swap successfully!');

      let suffixInput = this.isBuyPage ? 'USDT' : 'QMGT';
      let suffixOutput = this.isBuyPage ? 'QMGT' : 'USDT';

      let inputData = this.swapInValue + ' ' + suffixInput;
      let outputData;
      try {
        outputData = this.isBuyPage ? await this.calculateOutputBuy() : await this.calculateOutputSell();
      } catch (error) {
        console.log('outputData ', error);
      }
      outputData += ' ' + suffixOutput;

      window.location.href = this.swapSuccessPage + '?hash=' + result.transactionHash + '&inputData=' + inputData + '&outputData=' + outputData;
    } catch (error) {
      console.error('Swap failed', error);
      alert('Swap failed!')
    }
  },

  approveToken: async function() {
    let result;

    try {
      if (this.isBuyPage) {
        const tokenContract = this.tokenContractInstance();
        result = await tokenContract.methods.approve(this.contractAddress, this.web3.utils.toWei(1000000, 'Mwei')).send({ from: this.account });
        this.isApprovedUSDT = true;
      } else {
        const swapContract = this.swapContractInstance();
        result = await swapContract.methods.approve(this.contractAddress, this.web3.utils.toWei(1000000, 'ether')).send({ from: this.account });
        this.isApprovedQMGT = true;
      }
    } catch (error) {
      console.log('Error ==>>', error);
    }

    if (result.transactionHash) {
      alert('Approval successful!');
    }
  },

  calculateOutputBuy: async function() {
    let outputEl = this.getSwapOutElement();
    if (outputEl.element) {
      const contract = this.swapContractInstance();
      try {
        let result = await contract.methods.calculateTokens(this.web3.utils.toWei(this.swapInValue, 'Mwei')).call();
        result = this.convertBigNumber(result);
        result = result ? Math.floor(result * 1000) / 1000 : result
        
        if(outputEl.isInputTag) {
          outputEl.element.value = result;
        } else {
          outputEl.element.innerText = result;
        }

        return result;
      } catch (error) {
        console.error('CalculateOutput failed', error);
      }
    }
  },

  calculateOutputSell: async function() {
    try {
      const contract = this.swapContractInstance();
      let result = await contract.methods.calculateUSDT(this.web3.utils.toWei(this.swapInValue, 'ether')).call();
      result = this.convertBigNumber(result, 6);
      result = result ? Math.floor(result * 10000) / 10000 : result;

      return result;
    } catch (error) {
      console.error('CalculateOutput failed', error);
    }
  },

  connectMetamask: async function() {
    if (this.account) {
      window.location.href = this.buyTokenPage;

      return;
    }

    const provider = window.ethereum;
    if (provider) {
      this.web3 = new Web3(window.ethereum);

      try {
        const accounts = await provider.request({ method: 'eth_requestAccounts' });
        this.account = accounts[0];
        localStorage.setItem('walletAddress', accounts[0]);

        setTimeout(() => {
          if (this.account) {
            window.location.href = this.buyTokenPage;
          }
        }, 500);
      } catch (error) {
        console.error('User denied account access', error);
      }
    } else {
      console.error('Please install MetaMask!');
    }
  },

  connectCoinbase: async function(context) {
    if (this.account) {
      window.location.href = this.buyTokenPage;

      return;
    }

    if (typeof window.coinbaseWalletExtension !== 'undefined') {
      try {
        // Request access to the user's Ethereum accounts
        await window.coinbaseWalletExtension.request({ method: 'eth_requestAccounts' });

        // Get the user's Ethereum address
        const accounts = await window.coinbaseWalletExtension.request({ method: 'eth_accounts' });
        this.account = accounts[0];
        localStorage.setItem('walletAddress', accounts[0]);

        setTimeout(() => {
          if (this.account) {
            window.location.href = this.buyTokenPage;
          }
        }, 500);
      } catch (error) {
        console.error('Error connecting to Coinbase Wallet:', error);
      }
    } else {
      console.error('Coinbase Wallet extension is not available.');
    }
  },

  connectWeb3modal: async function(context) {
    if (this.account) {
      window.location.href = this.buyTokenPage;

      return;
    }

    if (window.modal) {
      try {
        let that = this;
        window.modal.subscribeProvider(function() {
          that.account = window.modal.getAddress();
          localStorage.setItem('walletAddress', that.account);

          setTimeout(() => {
            if (that.account) {
              window.location.href = that.buyTokenPage;
            }
          }, 500);
        });

        await window.modal.open();
      } catch (error) {
        console.error('Error connecting to Coinbase Wallet:', error);
      }
    } else {
      console.error('Coinbase Wallet extension is not available.');
    }
  },

  swapContractInstance: function() {
    if (!this.contractABI || !this.contractAddress) return;

    return new this.web3.eth.Contract(this.contractABI, this.contractAddress);
  },

  tokenContractInstance: function() {
    if (!this.tokenSwapABI || !this.tokenAddress) return;

    return new this.web3.eth.Contract(this.tokenSwapABI, this.tokenAddress);
  },

  displayTokenBalances: async function() {
    let tokenBalanceElements = this.getBalanceTokenElements();
    if (tokenBalanceElements && tokenBalanceElements.length) {
      let balance = 0;
      try {
        const tokenContract = this.tokenContractInstance();
        balance = await tokenContract.methods.balanceOf(this.account).call();
      } catch (e) {}

      tokenBalanceElements.forEach(el => {
        if (el) {
          el.innerText = this.convertBigNumber(balance, 6).toFixed(2);
        }
      })
    }
  },

  displayQMGTBalances: async function() {
    let qmgtBalanceElements = this.getBalanceQMGTElements();
    if (qmgtBalanceElements && qmgtBalanceElements.length) {
      const contract = this.swapContractInstance();
      if (!contract) return;

      let balance = 0;
      try {
        balance = await contract.methods.balanceOf(this.account).call();
      } catch (e) {}

      qmgtBalanceElements.forEach(el => {
        if (el) {
          el.innerText = this.convertBigNumber(balance).toFixed(4);
        }
      })
    }
  },

  displayBalances: async function() {
    this.displayTokenBalances();
    this.displayQMGTBalances();
    // let balanceInEl = this.getBalanceInElement();
    // let balanceOutEl = this.getBalanceOutElement();

    // try {
    //   const contract = this.swapContractInstance();
    //   if (!contract) return;

    //   const result = await contract.methods.balanceOf(this.account).call();
    //   if (balanceOutEl) {
    //     balanceOutEl.innerText = this.convertBigNumber(result).toFixed(2);
    //   }

    //   const tokenContract = new this.web3.eth.Contract(this.tokenSwapABI, this.tokenAddress);
    //   const resultTokenBalance = await tokenContract.methods.balanceOf(this.account).call();
    //   if (balanceInEl) {
    //     balanceInEl.innerText = this.convertBigNumber(resultTokenBalance).toFixed(2);
    //   }
    // } catch (error) {
    //   console.error('DisplayBalance failed', error);
    // }
  },

  getSwapInElement: function() {
    return document.querySelector(this.selectorSwapInputIn);
  },

  getSwapOutElement: function() {
    let outputContainer = document.getElementById(this.selectorSwapInputOutID);
    let outputElement = outputContainer.querySelector('input');

    return {
      isInputTag: !!outputElement,
      element: outputElement ? outputElement : outputContainer,
    };
  },

  getBalanceInElement: function() {
    return document.getElementById(this.selectorSwapBalanceInID);
  },

  getBalanceTokenElements: function() {
    return document.querySelectorAll(this.selectorSwapTokenBalance);
  },

  getBalanceQMGTElements: function() {
    return document.querySelectorAll(this.selectorSwapQMGTBalance);
  },

  getBalanceOutElement: function() {
    return document.getElementById(this.selectorSwapBalanceOutID);
  },

  getBalanceInElement1: function() {
    return document.getElementById(this.selectorSwapBalanceInID1);
  },

  getBalanceOutElement1: function() {
    return document.getElementById(this.selectorSwapBalanceOutID1);
  },

  getConnectedAddressElement: function() {
    return document.querySelectorAll(this.selectorConnectedAddress);
  },

  renderTxLink: function(txHash = '') {
    let txLinkElement = document.getElementById(this.selectorSwapTxSuccessLinkID);
    if (!txLinkElement || !this.swapContract) return;

    let networkScans = {
      '1': 'https://etherscan.io',
      '56': 'https://bscscan.com',
      '137': 'https://polygonscan.com',
      '11155111': 'https://sepolia.etherscan.io',
      '97': 'https://testnet.bscscan.com',
      '80002': 'https://amoy.polygonscan.com',
    }

    let transactionHash = txHash;
    const urlParams = new URLSearchParams(window.location.search);

    if (!txHash) {
      transactionHash = urlParams.get('hash');
    }
    if (!transactionHash) return;

    let inputData = urlParams.get('inputData');
    let outputData = urlParams.get('outputData');
    let successDescription = document.getElementById(this.selectorSwapSuccessDescriptionID);
    if (successDescription && inputData && outputData) {
      successDescription.innerText = 'Swapping ' + inputData + ' for ' + outputData;
    }

    let txLink = networkScans[this.swapContract.network] + '/tx/' + transactionHash;
    if (txLinkElement.tagName === 'A') {
      txLinkElement.href = txLink;
      txLinkElement.target = '_blank';
    } else {
      txLinkElement.addEventListener('click', function() {
        window.open(txLink);
      })
    }
  },

  convertBigNumber: function(bigNumber, decimal = 18) {
    if (!bigNumber) return 0;
  
    if (bigNumber._isBigNumber) {
      return bigNumber.div(new window.BigNumber(10).pow(decimal).toString()).toNumber();
    }
  
    let number = new window.BigNumber(bigNumber);
  
    return number.div(new window.BigNumber(10).pow(decimal).toString()).toNumber();
  },

  shortenAddress: function(address, preLength, sufLength) {
    const prefix = address.substring(0, preLength);
    const suffix = address.substring(address.length - sufLength);

    return prefix + '...' + suffix;
  },
}

SWAP_MODULE.init();

          </script>
          
        </html>